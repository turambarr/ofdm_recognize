# CP 成对峰验证功能说明

## 问题背景

在 OFDM 盲识别过程中，可能会遇到**虚假峰值**问题：
- 强周期性干扰（载波泄漏、直流偏移等）
- 非 OFDM 信号的规律性重复模式
- 多个 `Fs_guess` 候选收敛到同一个固定延迟 τ

这些虚假峰值会导致错误的参数估计。

## 解决方案：CP 成对峰验证

利用 **OFDM 循环前缀 (CP)** 的独特性质：

### OFDM 信号特征

1. **主峰位置**：τ₁ = N + Ng（完整符号周期）
   - 因为每个符号间隔 N+Ng 样本后，信号模式重复

2. **CP 副峰位置**：τ₂ = Ng（循环前缀长度）
   - 因为 CP 是符号尾部的拷贝，在 Ng 处也有自相关峰

3. **关系**：τ₂ / τ₁ = Ng / (N+Ng) ≈ 1/32 ~ 1/4（典型值）

### 验证逻辑

```
对于每个候选的 τ_main（主峰）：
  1. 预估 Ng_expected = τ_main × (多个典型 CP 比例)
  2. 在 [Ng_expected ± 容差] 范围内搜索副峰
  3. 计算 CP 副峰比例 = R0(Ng) / R0(τ_main)
  
  如果 CP 副峰比例 >= 阈值（如 15%）：
    ✓ 认为是真正的 OFDM 信号，保持原得分
  否则：
    ✗ 可能是虚假峰，大幅降低得分（惩罚 15 dB）
```

## 使用方法

### 基本用法

```matlab
Fr = 409.6e6;
opts.Detrend = true;
opts.Verbose = true;

% 设置 Fs_guess 候选
opts.Fs_guess = [320e6, 330e6, 340e6, 350e6];

% ===== 启用 CP 成对峰验证 =====
opts.EnableCPCheck  = true;   % 启用检查
opts.CPRatioMin     = 0.15;   % CP副峰至少15%主峰强度
opts.CPTolerancePct = 0.15;   % CP位置容差±15%
opts.CPPenaltyDB    = 15;     % 无CP峰时惩罚15dB

R = starlink_blind_id('signal.dat', Fr, opts);
```

### 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `EnableCPCheck` | `true` | 是否启用 CP 成对峰验证 |
| `CPRatioMin` | `0.15` | CP 副峰至少要达到主峰的多少比例才认可（15%） |
| `CPTolerancePct` | `0.15` | CP 位置搜索容差（±15%），应对频偏和时变 |
| `CPPenaltyDB` | `15` | 没有找到 CP 副峰时，对该候选的得分惩罚（dB） |

### 禁用 CP 检查（恢复原始行为）

```matlab
opts.EnableCPCheck = false;  % 仅基于动态范围选择
```

## 输出示例

### 启用 CP 检查时

```
---------- Fs_guess 候选 #1: 320.000 MHz ----------
[N/Fs] N=256: tau=[311,345], peak=0.002279@328, dyn=38.4 dB PASS [CP✓ 25.3%]
[N/Fs] N=512: tau=[622,689], peak=0.002138@685, dyn=27.0 dB PASS [CP✗ 8.2% PENALTY -15dB]
[N/Fs] N=1024: tau=[1245,1377], peak=0.002109@1346, dyn=25.7 dB PASS [CP✓ 18.5%]
...
[N/Fs] Chosen: N=1024, Nr=1346, Fs_hat=313.245 MHz, dyn=25.7 dB, CP ratio=18.5%
```

**说明**：
- `[CP✓ 25.3%]`：找到 CP 副峰，强度为主峰的 25.3%，通过验证
- `[CP✗ 8.2% PENALTY -15dB]`：CP 副峰太弱（8.2% < 15%），惩罚 15 dB

### 结果汇总

```
========== 所有 Fs_guess 候选结果汇总 ==========
[候选#1] Fs_guess=320.000 MHz → N=1024, Fs_hat=313.245 MHz, dyn=25.7 dB, CP=18.5%
[候选#2] Fs_guess=330.000 MHz → N=8192, Fs_hat=345.637 MHz, dyn=41.1 dB, CP=3.2%
[候选#3] Fs_guess=340.000 MHz → N=2048, Fs_hat=327.680 MHz, dyn=32.4 dB, CP=22.1%

[最佳] 选择候选 #1 (Fs_guess=320.000 MHz, CP验证得分=25.7 dB 最高)
```

注意候选#2虽然 `dyn=41.1 dB` 最高，但因为 `CP=3.2% < 15%`，实际得分被惩罚为 `41.1 - 15 = 26.1 dB`，反而不如候选#1。

## 诊断工具

运行后会自动生成 **R0 自相关曲线图**，显示：
- 蓝色曲线：完整的 |R0(τ)| 曲线
- 红色圆点：选定的主峰位置（τ = N+Ng）
- 绿色方块：预期的 CP 副峰位置（τ = Ng）

通过观察图形可以直观判断：
- 真正的 OFDM 信号：两个峰都明显
- 虚假周期性：只有主峰，CP 位置无峰值

## 参数调优建议

### 场景1：CP 检查过于严格（错过真信号）

**症状**：所有候选都被惩罚，报错"没有通过门限的候选"

**调整**：
```matlab
opts.CPRatioMin = 0.10;      % 放宽到 10%
opts.CPTolerancePct = 0.20;  % 扩大搜索范围到 ±20%
opts.CPPenaltyDB = 10;       % 减轻惩罚到 10 dB
```

### 场景2：仍然选到虚假峰

**症状**：选中的候选明显不合理，CP 比例很低

**调整**：
```matlab
opts.CPRatioMin = 0.20;      % 提高到 20%
opts.CPPenaltyDB = 20;       % 加重惩罚到 20 dB
```

### 场景3：已知信号没有标准 CP

**症状**：某些非标准 OFDM 变体（如 ZP-OFDM）

**调整**：
```matlab
opts.EnableCPCheck = false;  % 禁用 CP 检查
```

## 原理详解

### 为什么 CP 能区分真假峰？

#### 真实 OFDM 信号
```
符号结构：[CP|----------数据----------][CP|----------数据----------]
           ↑              ↑              ↑
          Ng          N+Ng          2(N+Ng)

R0(τ):
- τ = Ng      : ✓ 强峰（CP 与尾部相同）
- τ = N+Ng    : ✓ 强峰（符号周期）
- τ = 2(N+Ng) : ✓ 强峰（2倍符号周期）
```

#### 虚假周期信号（如载波泄漏）
```
简单正弦波：sin(2πf₀t + φ)
周期 T₀ = 1/f₀

R0(τ):
- τ = T₀      : ✓ 强峰（基波周期）
- τ = 0.13T₀  : ✗ 无峰（随机位置，不是 OFDM 的 Ng）
- τ = 2T₀     : ✓ 强峰（2倍周期）
```

**结论**：OFDM 有**成对峰**结构（主峰 + CP副峰），单纯周期信号没有。

## 技术细节

### CP 比例搜索策略

代码会尝试多个典型的 CP 比例：
```matlab
Ng_guess_ratio = [1/32, 1/16, 1/12, 1/8, 1/6, 1/4]
```

对应：
- 1/32 ≈ 3.1% （短 CP，如 LTE）
- 1/16 ≈ 6.25%（标准 CP）
- 1/8  ≈ 12.5% （长 CP）
- 1/4  = 25%   （极长 CP，Starlink 可能）

每个比例都会在 `[Ng_expected ± 15%]` 范围搜索，取最强的副峰。

### 得分计算

```
原始动态范围：dyn = 20*log10(max(R0) / min(R0))

CP 验证后：
  if CP_ratio >= CPRatioMin:
      cp_score = dyn              # 保持不变
  else:
      cp_score = dyn - CPPenaltyDB  # 大幅惩罚
```

最终选择 `cp_score` 最高的候选。

## 实验效果

基于你提供的数据：

### 启用前
```
所有候选都收敛到 τ ≈ 9708：
[候选#1] Nr=10257, dyn=39.1 dB
[候选#2] Nr=9708,  dyn=40.6 dB  ← 虚假峰
[候选#3] Nr=9708,  dyn=41.1 dB  ← 虚假峰（最高）
[候选#4] Nr=9708,  dyn=41.1 dB  ← 虚假峰
```

### 启用后（预期）
```
CP 检查识别虚假峰并惩罚：
[候选#1] Nr=10257, dyn=39.1 dB, CP=2.8%, score=24.1 dB
[候选#2] Nr=9708,  dyn=40.6 dB, CP=1.5%, score=25.6 dB  ← 被惩罚
[候选#3] Nr=5264,  dyn=38.8 dB, CP=18.3%, score=38.8 dB ← 真峰！
[候选#4] Nr=9708,  dyn=41.1 dB, CP=1.2%, score=26.1 dB  ← 被惩罚

选择候选#3（有明显 CP 副峰的真实 OFDM）
```

## 总结

**CP 成对峰验证**通过利用 OFDM 特有的循环前缀结构，有效区分：
- ✅ 真实的 OFDM 符号周期（有 CP 副峰）
- ❌ 虚假的周期性干扰（无 CP 副峰）

建议**默认启用**，仅在特殊情况下禁用。
